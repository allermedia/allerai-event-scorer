name: Build, Push, and Deploy Cloud Run Jobs and Services

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/deploy_cloud_run.yaml"
      - "images/**"
  workflow_dispatch:

jobs:
  detect-changed:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect modified folders
        id: set-matrix
        shell: bash
        run: |
          echo "üîç Detecting modified folders under images/"

          # Determine diff range (fallback for first run)
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            DIFF_RANGE="${{ github.event.before }} ${{ github.sha }}"
          else
            # First push or manual run: compare last commit
            DIFF_RANGE="${{ github.sha }}~1 ${{ github.sha }}"
          fi

          echo "Using diff range: $DIFF_RANGE"

          # Get changed files in images folder
          CHANGED=$(git diff --name-only $DIFF_RANGE | grep '^images/' || true)
          echo "Changed paths: $CHANGED"

          # Build JSON matrix of changed services/jobs
          declare -A UNIQUE_FOLDERS
          for path in $CHANGED; do
            TOP_FOLDER=$(echo "$path" | cut -d/ -f2)   # services or jobs
            SERVICE_NAME=$(echo "$path" | cut -d/ -f3) # folder n_
